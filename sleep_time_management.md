# 💤 睡眠時間Heartbeat管理系統

## 🕒 睡眠時間定義

### 香港時間睡眠時段
- **睡眠開始**: 晚上11:00 (23:00 HKT)
- **睡眠結束**: 早上8:00 (08:00 HKT)  
- **睡眠時長**: 9小時
- **UTC對應**: 15:00 - 00:00 UTC

### 例外情況
**即使在睡眠時間，以下情況仍應發送通知：**
1. **緊急提醒**：重要活動即將開始（<2小時）
2. **系統錯誤**：關鍵系統故障或服務中斷
3. **用戶請求**：用戶明確要求立即通知
4. **重大更新**：重要信息需要立即知曉

## 🔧 Heartbeat發送邏輯

### 正常時段 (08:00-23:00 HKT)
- **定期檢查**：按設定頻率發送heartbeat
- **完整報告**：包含所有提醒和更新
- **正常互動**：用戶活躍，可以接收通知

### 睡眠時段 (23:00-08:00 HKT)
- **靜默模式**：除非有重要更新，否則不發送
- **輕量檢查**：系統內部繼續運行檢查
- **延遲報告**：非緊急信息累積到早上報告
- **緊急覆蓋**：重要事件仍會通知

## 🎯 實施策略

### 時間判斷邏輯
```python
def should_send_heartbeat(current_utc_time):
    hk_time = current_utc_time + timedelta(hours=8)
    hour_hk = hk_time.hour
    
    # 睡眠時間 (23:00-08:00 HKT)
    if hour_hk >= 23 or hour_hk < 8:
        return check_for_important_updates()
    else:
        return True  # 正常發送
```

### 重要更新判斷標準
1. **時間敏感性**：活動在2小時內開始
2. **嚴重程度**：系統錯誤影響核心功能
3. **用戶指示**：明確要求立即通知
4. **外部事件**：需要立即關注的重要信息

## 📋 更新HEARTBEAT.md

需要在HEARTBEAT.md中添加睡眠時間管理說明：

```markdown
## Sleep Time Management
- **Sleep hours**: 23:00-08:00 HKT (15:00-00:00 UTC)
- **During sleep**: Heartbeat notifications are reduced/silenced
- **Exceptions**: Urgent reminders, system errors, user requests
- **Resume**: Full notifications resume at 08:00 HKT daily
```

## 🔄 系統調整

### 需要修改的組件
1. **Heartbeat檢查腳本**：添加時間判斷邏輯
2. **Cron Job調度**：調整睡眠時段的執行策略
3. **通知發送邏輯**：根據時段選擇發送方式
4. **日誌記錄**：記錄睡眠時段的靜默操作

### 實施步驟
1. 更新HEARTBEAT.md文檔
2. 修改heartbeat檢查邏輯
3. 測試不同時段的行為
4. 監控實施效果

## 📊 預期效果

### 用戶體驗改善
- **減少打擾**：睡眠時間不被不必要的通知打擾
- **保持功能**：重要信息仍能及時收到
- **智能管理**：系統自動判斷通知時機
- **透明操作**：用戶了解睡眠時間管理規則

### 系統效率提升
- **資源優化**：減少非必要時段的通信
- **專注重要**：集中處理真正需要關注的事項
- **用戶滿意**：尊重用戶的休息時間
- **可持續性**：建立長期可持續的通知策略

## 🧪 測試計劃

### 測試場景
1. **正常時段測試**：08:00-23:00 HKT的heartbeat行為
2. **睡眠時段測試**：23:00-08:00 HKT的靜默行為
3. **例外情況測試**：睡眠時段的重要更新通知
4. **時區轉換測試**：UTC與HKT的正確轉換

### 驗證標準
- ✅ 睡眠時段不發送常規heartbeat
- ✅ 重要更新在睡眠時段仍能通知
- ✅ 時間判斷準確無誤
- ✅ 用戶體驗無負面影響

## 📝 記錄與監控

### 日誌記錄
- 記錄每個heartbeat檢查的時間和決策
- 記錄睡眠時段的靜默操作
- 記錄例外情況的通知發送
- 定期審查日誌優化邏輯

### 用戶反饋
- 收集用戶對睡眠時間管理的反饋
- 根據反饋調整睡眠時段定義
- 優化重要更新的判斷標準
- 持續改進用戶體驗

---
**創建時間**: 2026年2月26日 01:35 UTC
**實施依據**: 用戶要求減少睡眠時間的heartbeat通知
**目標**: 在尊重用戶休息時間的同時保持重要信息的及時傳達